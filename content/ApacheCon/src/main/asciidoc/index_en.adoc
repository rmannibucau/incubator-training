////

  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

////

:description: After NoSQL discover CloudSQL databases
:keywords: ApacheCon, Database, JPA, SQL, Java, Embedded
:author: Enrico Olivelli & Romain Manni-Bucau
:talk: After NoSQL discover CloudSQL databases
:conference: APACHECON @Home
:conference_eu: APACHECON EU
:conference_na: APACHECON NA
:conference_home: APACHECON @Home
:dates: Spt. 29th - Oct. 1st
:year: 2020

[%notitle.title-slide]
== {talk}
image::ApacheCon_bg.jpg[background,size=cover]

[.toplogo]
image:ApacheConAtHome.png[width=100%]

[.righttitle]
--
{talk}

{author}
--

[.conferenceName]
{conference_home} +
{dates}

[.year]
{year}

== Enrico Olivelli

Working at link:https://emailsuccess.com/[EmailSuccess.com] and link:https://magnews.com/[MagNews.com]

OpenSource enthusiast, contributing to ASF projects BookKeeper, ZooKeeper, Curator, Pulsar, Maven.

link:https://twitter.com/eolivelli[@eolivelli] on Twitter

link:https://github.com/eolivelli[@eolivelli] on GitHub


== Romain Manni-Bucau

link:https://twitter.com/rmannibucau[image:romain/twitter.png[width=100%], window="_blank"]
link:https://rmannibucau.metawerx.net[image:romain/blog.png[width=100%], window="_blank"]
link:https://github.com/rmannibucau[image:romain/github.png[width=100%], window="_blank"]
link:https://www.yupiik.com/[image:romain/yupiik.png[width=100%], window="_blank"]

== Introducing HerdDB

image:herddblogo.png[HerdDB,200,100,float=right]

[%step]
* HerdDB is a Distributed SQL Database written in Java.
* JDBC support
* MySQL compatible dialect.
* Run embedded in the host client Java application.
* Support high-availability.
* Support horizontal scalability.

== HerdDB history

.Motivations:
[%step]
* Started inside EmailSuccess.com as a replacement for MySQL.
* EmailSuccess is a written in Java and it uses a DB to store message state.
* In 2016 we started the development of EmailSuccess Cluster
* We needed a better solution for storing message state.

== HerdDB history

.Requisites:
[%step]
* Embedded: The database should run inside the same Java process (like SQLLite)
* Replicated: The database should scale out and offer high-availability automatically

[%step]
* Solutions were already present on the market, but nothing could meet both of the requirements.

== HerdDB users

Currently HerdDB is used in production:
[%step]
* As Primary SQL DB for EmailSuccess.com standalone and cluster
* As SQL Database for Apache Pulsar Manager (https://github.com/apache/pulsar-manager)
* As Metadata Service on BlobIt – Binary Large Object Storage built over Apache BookKeeper (https://github.com/diennea/blobit)
* As Configuration and Certificate store for CarapaceProxy HTTP server (https://github.com/diennea/carapaceproxy)
* As MySQL replacement in a few other non Open Source internal products at https://diennea.com
* In HerdDB Collections Framework flavour at https://magnews.com 

[.side-by-side.large]
== Embedding the database

[.side]
.*Advantages* icon:check[green]
[%step]
* No additional deployment and management tools for users.
* The database is hidden to the user, you have to manage «only» the application.
* The application is tested with only one version of the Database (the same as in production).
* Easier to test for developers  (run the DB in-memory for unit tests).

[.side]
.*Challenges* icon:question[yellow]
[%step]
* Memory management: the DB cannot use all of the heap of the client application.
* Have sensible defaults and enable automatic management routines by default.
* Handle upgrade procedures automatically, without manual intervention.
* Pay much attention to wire protocol changes and to disk formats.

== Replication: high-availability  and scalability.

.Benefits:
[%step]
* Work even in case of temporary or permanent loss of machines.
* Keep data closer to the clients.
* No shared disks or network file systems.
* Scale out by adding machines to the application.

== Replication: high-availability  and scalability.

.Challenges:
[%step]
* Handle gracefully temporary failures: long GC pauses, application restart.
* Understand storage topology: WAL and cold Data have separate replication mechanisms.
* Need some external source of truth: Apache ZooKeeper.

[.side-by-side]
== HerdDB model

[.side]
image:herddbtablespace.png[width=80%]

[%step.side.smaller]
* TableSpaces: a TableSpace is a group of Tables, very like to a "database" in MySQL world.
* Table: table is a table !
* Transactions: Transactions and Joins can span tables of the same TableSpace
* A TableSpace must reside entirely on every machine assigned to it.


== Tables: a key-value store seen as an SQL structure

[%step]
* A Table is a simple key-value dictionary (byte[] -> byte[]).
* Clients use JDBC API and SQL language.
* On top of the key-value structure we have a SQL layer:
** Key = Primary Key
** Value = All of the other columns
* We are using Apache Calcite for SQL work: Parser and Planner.
* Working on a smaller jSQLParser based stack.

== Tables: Core Data Structures

[%step]
* Data Page: a bunch of records, indexes by PK (hashmap)
* Primary Key Index: a map that binds a PK value to the id of a data page
* Dirty Page Buffer: a Data Page that is open for writes
* Secondary indexes: they map a value to a set of PKs
* HerdDB Collections Framework uses directly the Key Value structure without the SQL layer.

== Replication overview

An HerdDB cluster is made of:

* HerdDB servers
* Apache BookKeeper servers (Bookies)
* Apache ZooKeeeper servers

Each TableSpace elects a *leader* node

BookKeeper guarantees the consistency of the cluster
ZooKeeper handles metadata and provides service discovery

[.side-by-side]
== How replication works

[.side]
* Clients talk only to the *leader*
* Changes are written to the Bookies that represent the write-ahead-log
* Other nodes (*followers*) tail the write-ahead-log and apply locally the same changes (async replication)
* When a *follower* is promoted to *leader* it fences out the old leader

[.side]
image:replication.png[]

[.medium]
== YCSB Benchmarks

[opts="header",role="small-font-for-table",cols="1,2,2,2,6"]
|===
| Workload | HerdDB (ops/s) | MySQL (ops/s) | Ratio | Description
| Load |21 239	| 5 153	| 412%	|100% INSERT
| A | 10 877 | 9 829 |  111%	|50% READ - 50% UPDATE (Update heavy)
| B | 42 616 | 34 090 |  125%	|95% READ - 5% UPDATE (Read mostly)
| C | 52 343 | 9 829 |  141%	|100% READ (Read Only)
| D | 47 129 | 33 553 |  140%	|95% READ (latest rows) - 5% INSERT (Read latest)
| E | 12 342 | 9 487 |  130%	|95% SCAN (short range of records) - 5% INSERT
| F | 9 977 | 9 462 |  105%	|50% READ - 50% READ,MODIFY,WRITE
| EMS | 19 686 | 5 749 | 342%	|32% INSERT - 64% UPDATE - 4% READ
|===

image:ycsb.png[width=75%]

[.smaller]
NOTE: result captures with HerdDB 0.19 and MySQL 5.7.24 on a bare metal machine with SSD, on Linux, JDK13.

//NOTE:  more on https://github.com/brianfrankcooper/YCSB/wiki/Core-Workloads

== JDBC is good but JPA is better

[%step]
* JDBC is low level
* Lot of applications using JPA for
** Simpler coding/maintenance
** Database portability
* So question is:
+
> What if HerdDB would work with JPA?

== JPA setup

> JPA uses JDBC under the hood.

...so it is trivial, right?

== JPA Challenges

[%step.small-margin]
* JPA issue SQL statements. All databases are all SQL *_based_*
* All databases use custom types and functions (some overlap)
+
> JPA providers use a dialect/dictionary/platform.
* Joins must be supported
* Case must be handled for HerdDB
+
> OpenJPA OOTB dictionnaries are case insensitive for example.
* Delimiters must be handled properly
* Reserved words must be handled

[.small-margin.medium]
== JPA statements example

[plantuml,format=svg,role="no-margin"]
....
left to right direction
MyEntity "1" *-- "*" MyEntity_tags : contains
....

[source,java]
----
@Entity
@Getter @Setter
public class MyEntity {
    @Id private String id;
    // ...
    @CollectionTable
    private Collection<String> tags;

}
----

[%step.wide.no-margin]
- DDL (table)
+
[source,sql]
----
CREATE TABLE `MyEntity` (`id` VARCHAR(255) NOT NULL, `created` TIMESTAMP, `updated` TIMESTAMP, `name` VARCHAR(255),`notSortable` VARCHAR(255), `version` BIGINT, PRIMARY KEY (`id`))

CREATE TABLE `MyEntity_tags` (`MyEntity_id` VARCHAR(255), `element` VARCHAR(255))
----
+
- DDL (indices)
+
[source,sql]
----
CREATE INDEX `I_MYNTTGS_MYENTITY_ID` ON `MyEntity_tags` (`MyEntity_id`)
----
+
- Write (`INSERT` or `UPDATE`)
+
[source,sql]
----
INSERT INTO `MyEntity` (`id`, `created`, `updated`, `name`, `notSortable`, `version`)  VALUES (?, ?, ?, ?, ?, ?)
----
+
- Query
+
[source,sql]
----
SELECT t0.`id`, t0.`version`, t0.`created`, t0.`updated`, t0.`name`, t0.`notSortable`  FROM `MyEntity` t0 ORDER BY t0.`name` ASC
----
+
- `DELETE`
+
[source,sql]
----
DELETE FROM `MyEntity_tags` WHERE `MyEntity_id` = ? 
DELETE FROM `MyEntity` WHERE `id` = ? AND `version` = ? 
----

== Specific OpenJPA dictionary 1/2

[%step]
* `persistence.xml`
+
[source,xml,subs=+quotes]
----
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<persistence xmlns="http://xmlns.jcp.org/xml/ns/persistence"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="
                http://xmlns.jcp.org/xml/ns/persistence
                http://xmlns.jcp.org/xml/ns/persistence/persistence_2_1.xsd"
             version="2.1">
  <persistence-unit name="applicationPetstorePU" transaction-type="JTA">
    <jta-data-source>java:global/datasource/petstore</jta-data-source>
  </persistence-unit>
</persistence>
----
+
** Nothing special!
+
* Startup logs
+
[source,subs=+quotes]
----
INFO openjpa.Runtime - Starting *OpenJPA* 3.1.3
INFO openjpa.jdbc.JDBC - Using dictionary class *"org.apache.openjpa.jdbc.sql.HerdDBDictionary"* (HerdDB 0.20.0 ,HerdDB 0.20.0).
INFO openjpa.jdbc.JDBC - Connected to HerdDB version 0.20 using JDBC driver HerdDB version 0.20.0.
----

== Specific OpenJPA dictionary 2/2

[%step]
* Automatically detected (as any other database)
* Handled quoting
* Handled reserved keywords
* Handled case
* Handled delimiters
* Almost an Apache Calcite dictionary (even in `jsqlparser mode`)

== DataSource definition

[source,xml]
----
<Resource id="global/datasource/perstore" type="DataSource">
    # JdbcUrl = jdbc:herddb:local?server.planner.type=jsqlparser
    # JdbcUrl = jdbc:herddb:server:localhost:7000
    # JdbcUrl = jdbc:herddb:zookeeper:server1:2181,server2:2181/herddb
    JdbcUrl = jdbc:herddb:local
    JdbcDriver = herddb.jdbc.Driver
    UserName = sa
    Password = hdb
</Resource>
----

NOTE: this uses TomEE definition syntax but is generic

TIP: can also be done in `persistence.xml` (icon:warning[yellow] pooling)

== Usage challenges

[%step]
* Application often use H2/HSQLDB for fast testing roudtrips
** HerdDB must be close to keep a fluent testing workflow
* H2/HSQLDB are light
** HerdDB must stay light (in its fatjar bundle) to compete with these alternatives in embed mode

== Usage figures

Uses petstore demo application (small but real like app) with a few data (test alike).

[opts="header",role="medium"]
|===
| Criteria                    | H2    | MySQL | Herdb (embedded/jsqlparser) | Herdb (embedded/calcite) | HerdDB remote (sync) | HerdDB remote (async flush)
| First findall               | 0.15s | 0.18s | 0.38s | 0.19s | 0.2s  | 0.17s
| Hot   findall               | 1.0ms | 1.0ms | 7ms   | 5.5ms | 2.9ms | 2.8ms
| Startup/DS creation (empty) | 463ms | 764ms | 0.7s  | 1s    | 393ms | 393ms
|===

[.medium]
NOTE: similar ratios for a real application, still in local mode. 35 tables (max 75 columns in a table), 35 indices, 302 columns, 10 select all executed in main tables.

[.medium]
TIP: CDS can /2 the startup time (but not that usable in tests).

== JPA Conclusion

[%step]
* HerdDB is trivial to setup
* HerdDB can replace any database almost transparently
* HerdDB can optimize your scalability in several cases
* HerdDB is not yet a testing replacement of H2/HSQLDB
* HerdDB is a RDBMS self-hostable (embeddable) and scalable, it is your Cloud friend
** Saves a lot of $$ compared to managed instances

== What about k8s

Challenge with Kubernetes: persistence and retention.

[%step]
* Kubernetes and persistence options:
** Persistence Volume (+ Claim) - local or remote storage (S3, NFS, ...)
** StatefuleSet (combine deployments and PV/PVC) - better but has some "bugs"

== HerdDB as a kill them all solution?

[%step]
* Enables to abstract the cloud provider
* Enables to still use SQL and not depend on HTTP services (MinIO) without tx support
* Enables to deploy the same application on promise or cloud providers
* Enables to optimize the deployment (replica in the app or same pod than the app)

== HerdDB the Modern DB

[%step]
* OpenSource (+ free)
* Fault Tolerant and Scalable (cloud friendly)
* Managed as a service - embed or not - (/application) so cheaper than managed DB
* Usable in tests and prod (less surprises)
* Compatible with most SQL tools (so all our tools)
* Evolutive (thanks SQL) compared to NoSQL

[.big]
== Last word

> Databases are moving from vendor reserved area to developers in cloud native apps. Be prepared!

> Great power comes great responsibility!

[%notitle.big-thanks]
== Thanks
image::ApacheCon_bg.jpg[background,size=cover]

[.toplogo]
image:ApacheConAtHome.png[width=100%]

Thanks
Questions?
