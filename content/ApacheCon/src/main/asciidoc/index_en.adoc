////

  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

////

:description: After NoSQL discover CloudSQL databases
:keywords: ApacheCon, Database, JPA, SQL, Java, Embedded
:author: Enrico Olivelli & Romain Manni-Bucau
:talk: After NoSQL discover CloudSQL databases
:conference: APACHECON @Home
:conference_eu: APACHECON EU
:conference_na: APACHECON NA
:conference_home: APACHECON @Home
:dates: Spt. 29th - Oct. 1st
:year: 2020

[%notitle]
== {talk}
image::ApacheCon_bg.jpg[background,size=cover]

[.toplogo]
image:ApacheConAtHome.png[width=100%]

[.righttitle]
--
{talk}

{author}
--

[.conferenceName]
{conference_home} +
{dates}

[.year]
{year}

== Enrico Olivelli

TBD

== Romain Manni-Bucau

link:https://twitter.com/rmannibucau[image:romain/twitter.png[width=100%], window="_blank"]
link:https://rmannibucau.metawerx.net[image:romain/blog.png[width=100%], window="_blank"]
link:https://twitter.com/rmannibucau[image:romain/github.png[width=100%], window="_blank"]
link:https://www.yupiik.com/[image:romain/yupiik.png[width=100%], window="_blank"]

== Introducing HerdDB

Why HerdDB ?

HerdDB started inside EmailSuccess.com as a replacement for MySQL.

EmailSuccess is a pure Java application and it is a distributed system.

.HerdDB design requirements:
* Support JDBC and be compatible with MySQL dialect.
* Run embedded in the host client Java application.
* Support high-availability.
* Support horizontal scalability.

== HerdDB history

HerdDB is a Distributed Database System, designed from the ground up to run inside the same process of client applications.

The project started inside EmailSuccess.com, a Mail Transfer Agent (like sendmail).

EmailSuccess is a written in Java and it initially we used MySQL to store message state.

In 2016 we started the development of EmailSuccess Cluster and we needed a better solution for storing message state.

.Requisites:

* Embedded: The database should run inside the same Java process (like SQLLite)
* Replicated: The database should scale out and offer high-availability automatically

Solutions were already present on the market, but nothing could meet both of the requirements.

== HerdDB users

Currently HerdDB is used in production:

* As Primary SQL DB for EmailSuccess.com standalone and cluster
* As SQL Database for Apache Pulsar Manager (https://github.com/apache/pulsar-manager)
* As Metadata Service on BlobIt – Binary Large Object Storage built over Apache BookKeeper (https://github.com/diennea/blobit)
* As Configuration and Certificate store for CarapaceProxy HTTP server (https://github.com/diennea/carapaceproxy)
* As MySQL replacement in a few other non Open Source internal products at https://diennea.com
* In HerdDB Collections Framework flavour at https://magnews.com 

== Embbeding the database

.Advantages
* No additional deployment and management tools for users.
* The database is hidden to the user, you have to manage «only» the application.
* The application is tested with only one version of the Database (the same as in production).
* Easier to test for developers  (run the DB in-memory for unit tests).

.Challenges:
* Memory management: the DB cannot use all of the heap of the client application.
* Have sensible defaults and enable automatic management routines by default.
* Handle upgrade procedures automatically, without manual intervention.
* Pay much attention to wire protocol changes and to disk formats.

== Replication: high-availability  and scalability.

.Benefits:
* Work even in case of temporary or permanent loss of machines.
* Keep data closer to the clients.
* No shared disks or network file systems.
* Scale out by adding machines to the application.

.Challenges:
* Handle gracefully temporary failures: long GC pauses, application restart.
* Understand storage topology: WAL and cold Data have separate replication mechanisms.
* Need some external source of truth: Apache ZooKeeper.

== Design

.HerdDB model
* TableSpaces: a TableSpace is a group of Tables, very like to a "database" in MySQL world.
* Table: table is a table !
* Transactions: ransactions and joins that span tables of the same TableSpace

A TableSpace must reside entirely on every machine assigned to it.

image:herddbtablespace.png[width=100%]

== Tables: a key-value store seen as an SQL structure

* A Table is a simple key-value dictionary (byte[] -> byte[]).
* Clients use JDBC API and SQL language.
* On top of the key-value structure we have a SQL layer:
** Key = Primary Key
** Value = All of the other columns

We are using Apache Calcite for SQL work: Parser and Planner.

== Tables: a key-value store seen as an SQL structure

Core Data Structures:

* Data Page: a bunch of records, indexes by PK (hashmap)
* Primary Key Index: a map that binds a PK value to the id of a data page
* Dirty Page Buffer: a Data Page that is open for writes
* Secondary indexes: they map a value to a set of PKs

HerdDB Collections Framework uses directly the Key Value structure without the SQL layer.

== Replication overview

An HerdDB cluster is made of:

* HerdDB servers
* Apache BookKeeper servers (Bookies)
* Apache ZooKeeeper servers

Each TableSpace elects a *leader* node.

Apache BookKeeper guarantees the consistency of the cluster
Apache ZooKeeper handles metadata and provides service discovery

== Replication overview

How replication works:

* Clients talk only to the *leader*
* Changes are written to the Bookies that represent the write-ahead-log
* Other nodes (*followers*) tail the write-ahead-log and apply locally the same changes (async replication)
* When a *follower* is promoted to *leader* it fences out the old leader


== Benchmarks

Comparing MySQL vs HerdDB on a bare metal machine with SSD, on Linux, JDK13.

[opts="header"]
|===
| YCSB Workload | HerdDB 0.19.0 (ops/s) | MySQL 5.7.24  (ops/s) | Ratio | Description
| Loadphase |21239	| 5153	| 412%	|100% INSERT
| WorkloadA | 10877 | 9829 |  111%	|50% READ - 50% UPDATE
| WorkloadB | 42616 | 34090 |  125%	|95% READ - 5% UPDATE
| WorkloadC | 52343 | 9829 |  141%	|100% READ
| WorkloadD | 47129 | 33553 |  140%	|95% READ (latest rows) - 5% INSERT
| WorkloadE | 12342 | 9487 |  130%	|95% SCAN (short range of records) - 5% INSERT
| WorkloadF | 9977 | 9462 |  105%	|50% READ - 50% READ,MODIFY,WRITE
| WorkloadEMS | 19686 | 5749 | 342%	|342	32% INSERT - 64% UPDATE - 4% READ
|===


image:ycsb.png[width=100%]

== JDBC is good but JPA is better

[%step]
* JDBC is low level
* Lot of applications using JPA for
** Simpler coding/maintenance
** Database portability
* So question is:
+
> What if HerdDB would work with JPA?

== JPA setup

> JPA uses JDBC under the hood.

...so it is trivial, right?

== JPA Challenges

[%step]
* JPA issue SQL statements. All databases are all SQL based but make it vary/enhance it
* All databases use custom types (even if some overlap)
+
> So all JPA providers abstract each database by a dialect/dictionary/platform.
* Joins must be supported
* Case must be handled
+
> All default OpenJPA dictionnaries are case insensitive for example.
* Delimiters must be handled properly
* Reserved words must be handled

== JPA statements example

[source,sql]
----
CREATE TABLE `MyEntity` (
    `id` VARCHAR(255) NOT NULL, `created` TIMESTAMP, `updated` TIMESTAMP,
    `name` VARCHAR(255), `notSortable` VARCHAR(255),
    `version` BIGINT, PRIMARY KEY (`id`))
CREATE TABLE `MyEntity_tags` (`MyEntity_id` VARCHAR(255), `element` VARCHAR(255))

CREATE INDEX `I_MYNTTGS_MYENTITY_ID` 
    ON `MyEntity_tags` (`MyEntity_id`)

INSERT INTO `MyEntity` (`id`, `created`, `updated`, `name`, `notSortable`, `version`) 
    VALUES (?, ?, ?, ?, ?, ?)

SELECT t0.`id`, t0.`version`, t0.`created`, t0.`updated`, t0.`name`, t0.`notSortable` 
    FROM `MyEntity` t0 ORDER BY t0.`name` ASC

DELETE FROM `MyEntity_tags` WHERE `MyEntity_id` = ? 
DELETE FROM `MyEntity` WHERE `id` = ? AND `version` = ? 
----

== Custom OpenJPA dictionary

[source,subs=+quotes]
----
INFO openjpa.Runtime - Starting *OpenJPA* 3.1.3
INFO openjpa.jdbc.JDBC - Using dictionary class "*org.apache.openjpa.jdbc.sql.HerdDBDictionary*" (HerdDB  ,HerdDB 0.0).
INFO openjpa.jdbc.JDBC - Connected to *HerdDB* version 0.0 using JDBC driver HerdDB version 0.0.
----

[%step]
* Automatically detected (as any other database)
* Handled quoting
* Handled reserved keywords
* Handled case
* Handled delimiters
* Almost an Apache Calcite dictionary

== Usage challenges

[%step]
* Application often use H2/HSQLDB for fast testing roudtrips
** HerdDB must be close to keep a fluent testing workflow
* H2/HSQLDB are light
** HerdDB must stay light (in its fatjar bundle) to compete with these alternatives in embed mode

== Usage figures 1/2

[opts="header"]
|===
| Criteria               | H2        | Herdb
| Driver Size            | 2.2M      | 61K (+ netty + calcite + bookkeeper)/35M (shadowed)
| Local setup cost (ms)  | 11ms      | 1.9s
|===

NOTE: uses a minimal database to only take into account driver cost.

== Usage figures 2/2

[opts="header"]
|===
| Criteria  | H2    | Herdb
| Java 8    | 1.15s | 2.8s
| Java 11   | 1.38s | 2.7s
|===

NOTE: uses a real application database in an application using netty for the HTTP server (so classes are already loaded), still in local mode. 35 tables (max 75 columns in a table), 35 indices, 302 columns, 10 select all executed in main tables.

TIP: CDS can /2 the startup time (but not usable in tests).

== Usage figures: warning

> THIS IS ONLY ABOUT STARTUP TIME, RUNTIME IS FINE!

== JPA Conclusion

[%step]
* Herddb is trivial to setup
* Herddb can replace any database almost transparently
* Herddb can optimize your scalability in several cases
* Herddb is not yet a testing replacement of H2/HSQLDB
* Herddb is a RDBMS self-hostable (embeddable) and scalable, it is your Cloud friend
** Saves a lot of $$ compared to managed instances

== What about k8s

Challenge with Kubernetes: persistence and retention.

TODO: yamls

[%notitle.big-thanks]
== Thanks
image::ApacheCon_bg.jpg[background,size=cover]

[.toplogo]
image:ApacheConAtHome.png[width=100%]

Thanks
Questions?

[%notitle]
== {talk}
image::AtHomeSpiceRack.jpg[canvas]

[.centered]
--
{talk}

'''

{author}
--

[.conferenceName]
{conference_home} +
{dates}

[.year]
{year}

[%notitle]
== {talk}
image::AtHomeDesktop.jpg[canvas]

[.centered]
--
{talk}

'''

{author}
--

[.conferenceName]
{conference_home} +
{dates}

[.year]
{year}

[%notitle]
== {talk}
image::AtHomeDesktopII.jpg[canvas]

[.centered]
--
{talk}

'''

{author}
--

[.conferenceName]
{conference_home} +
{dates}

[.year]
{year}

[%notitle]
== {talk}
image::AtHomeOutside.jpg[canvas]

[.centered]
--
{talk}

'''

{author}
--

[.conferenceName]
{conference_home} +
{dates}

[.year]
{year}

== Simple Slide
* one
* two
* three

[.notes]
--
Speaker notes go here
--

== Sub Points
* one
** and this
** and more
* two
* three


== Styles and Custom Styles
Text can be **bold**, __italic__, [.big]#big# or [.small]#small#

== Image
image::ApacheConAtHome.png[]

== Two Columns
[.twocolumns]
--
* one
* two
* three

image::ApacheConAtHome.png[]
--

== Command Line
monospace text - find and copy all the images! +
`find . -name "*.jpg" -exec cp {} images \;`

== Java Code

[source,java]
----
public class HelloWorld {

    public static void main(String[] args) {
        System.out.println("Hello, World");
    }
}
----


== Optional Slides
Press down arrow to see the optional slide.

=== Optional Slide
This is an optional slide.

== Quote
[quote, Albert Einstein]
A person who never made a mistake never tried anything new.

== Passthrough
Anything in a passthrough  is passed to the output unprocessed so you can include raw HTML and Javascript.

++++
<p>This is a <b>HTML</b> paragraph</p>
++++


== Apache Training Project

These slides are part of the Apache Training project.
https://training.apache.org
